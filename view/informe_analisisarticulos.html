{include="header"}
<!--
Copyright (C) 2016 Joe Nilson <joenilson@gmail.com>

 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->
<div class="container-fluid" style="margin-top: -10px;">
    <div class="row">
        <div class="col-sm-12 text-left">
            <h2>Análisis de Stock</h2>
            <p align="left">Por favor seleccione el rango de fechas, el almacen involucrado y proceda a darle click al boton <b>Generar Informaci&oacute;n</b></p>
            <hr />
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <form id="f_generar_reporte" method="POST" action='{$fsc->url()}'>
            <input type="hidden" name="tipo-reporte" id="tipo-reporte" value='{$fsc->reporte}'>
            <div class="form-group col-xs-2 col-md-2">
                <label for='inicio' class="control-label"><b>Fecha Inicio</b></label>
                <input type="text" class="form-control datepicker" name='inicio' id="inicio">
            </div>
            <div class="form-group col-xs-2 col-md-2">
                <label for='fin'><b>Fecha Fin</b></label>
                <input type="text" class="form-control datepicker" name="fin" id="fin">
            </div>
            <div class="form-group col-xs-2 col-md-2">
                <label for='codalmacen'><b>Almacen</b></label>
                <select class="form-control selectpicker" multiple name="codalmacen" id="codalmacen" data-style="btn-default" data-actions-box="true" required>
                    {loop="$fsc->almacenes->all()"}
                        <option value="{$value->codalmacen}">{$value->nombre}</option>
                    {/loop}
                </select>
            </div>
            <div class="form-group col-xs-2 col-md-2">
                <label class="control-label" for='codfamilia'><b>Familia</b></label>
                <select class="form-control selectpicker" multiple name="codfamilia" id="codfamilia" data-style="btn-default" data-actions-box="true">
                    {loop="$fsc->familias->all()"}
                        <option value="{$value->codfamilia}">{$value->descripcion}</option>
                    {/loop}
                </select>
            </div>
            <div class="form-group-sm col-xs-2 col-md-2">
                <label class="control-label" for='referencia'><b>Articulo</b></label>
                <select class="form-control input-sm selectpicker" multiple name="referencia" id="referencia" data-style="btn-default" data-actions-box="true">
                    {loop="$fsc->articulos->all()"}
                        <option value="{$value->referencia}">{$value->descripcion}</option>
                    {/loop}
                </select>
            </div>
            <div class="form-group col-xs-2 col-md-2">
                <br />
                <button class="btn btn-default btn-sm" type="submit" id="b_generar_reporte" name="buscar">Generar Informaci&oacute;n</button>
                <a id="b_descargar_reporte" class="btn btn-primary btn-sm" href="" style="display: none;">Descargar Reporte</a>
            </div>
        </form>
    </div>
    <div class="row">
        <div id="kardex-resultados">
            <table id="grid_kardex"></table>
            <div id="grid_kardex_pager"></div>
        </div>
    </div>
</div>
<script>
    $.fn.selectpicker.defaults = {
        selectAllText: 'Marcar Todo',
        deselectAllText: 'Desmarcar',
        noneSelectedText: 'Nada seleccionado',
        countSelectedText: "{0} de {1} selecionados",
        selectedTextFormat: 'count'
    };
    
    $.jgrid.defaults.width = '100%';
    $.jgrid.defaults.responsive = true;
    $.jgrid.defaults.styleUI = 'Bootstrap';
    
    function last_stock(val, name, record){
        return parseFloat(record[name]||0);
    }
    
    function get_stock(){
        var inicio = $('#inicio').val();
        var fin = $('#fin').val();
        var almacen = $('#codalmacen').val();
        var familia = $('#codfamilia').val();
        var articulo = $('#referencia').val();
        $.ajax({
            type: 'POST',
            url: '{$fsc->url()}',
            async: false,
            data: 'procesar-reporte=true&inicio='+inicio+'&fin='+fin+'&almacen='+almacen+'&familia='+familia+'&articulo='+articulo,
            success: function(datos) {
                $("#grid_kardex").jqGrid('clearGridData');
                $("#grid_kardex").jqGrid({
                    title: 'Kardex del '+inicio+' al '+fin,
                    data: datos.rows,
                    datatype: "local",
                    colModel: [
                        { label: 'Almacén', name: 'nombre', width: 150 },
                        { label: 'Fecha', name: 'fecha', key: true, width: 150 },
                        { label: 'Documento', name: 'tipo_documento', width: 70 },
                        { label: 'Número', name: 'documento', width: 70 },
                        { label: 'Artículo', name: 'descripcion', width: 150 },
                        {
                            label: 'Salida',
                            name: 'salida_cantidad',
                            width: 70,
                            summaryTpl : "<b>{0}</b>",
                            formatter: 'number', align: 'right', summaryType: 'sum',
                            formatoptions : { decimalSeparator: ".", decimalPlaces:2, thousandsSeparator:"," }
                        },
                        {
                            label: 'Ingreso',
                            name: 'ingreso_cantidad',
                            width: 70,
                            summaryTpl : "<b>{0}</b>",
                            formatter: 'number', align: 'right', summaryType: 'sum',
                            formatoptions : { decimalSeparator: ".", decimalPlaces:2, thousandsSeparator:"," }
                        },
                        {
                            label: 'Saldo',
                            name: 'saldo_cantidad',
                            width: 70,
                            summaryTpl : "<b>{0}</b>",
                            formatter: 'number', align: 'right', summaryType: last_stock,
                            formatoptions : { decimalSeparator: ".", decimalPlaces:2, thousandsSeparator:"," }
                        }
                    ],
                    loadonce:true,
                    viewrecords: true,
                    rowList: [100,150,200],
                    headertitles: true,
                    autowidth: true,
                    height: 450,
                    rowNum: 100,
                    sortname: 'fecha',
                    pager: "#grid_kardex_pager",
                    grouping: true,
                    hoverrows: true,
                    groupingView: {
                        groupField: ["nombre", "descripcion"],
                        groupColumnShow: [true, true],
                        groupText: [
                            "<b>{0}</b>",
                            "<b>{0}</b>"
                        ],
                        groupOrder: ["asc", "asc"],
                        groupSummary: [true, false],
                        groupSummaryPos: ['header', 'header'],
                        groupCollapse: false
                    }
                });
                $('#grid_kardex').jqGrid()
                    .setGridParam({
                        data: datos.rows
                    })
                    .trigger("reloadGrid");

                $('#grid_kardex').navGrid('#grid_kardex_pager',
                    { edit: false, add: false, del: false, search: true, refresh: false, view: false, position: "left", cloneToTop: true
                });
                $('#b_descargar_reporte').attr('href',datos.filename);
                $('#b_descargar_reporte').show();

            }
        });
    }

    function runningFormatter(value, row, index) {
        return index;
    }

    function totalFormatter(data) {
        return data.length + ' Documentos';
    }

    function totalTextFormatter(data) {
        return 'Total';
    }

    function numberFormatter(value, row, index) {
        return parseFloat(value).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
    }

    function sumFormatter(data) {
        field = this.field;
        return parseFloat(data.reduce(function(sum, row) {
            return sum + (+row[field]);
        }, 0)).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
    }

    function sumNormalFormatter(data) {
        field = this.field;
        return parseFloat(data.reduce(function(sum, row) {
            return sum + (+row[field]);
        }, 0)).toFixed(2);
    }

    $('#inicio').datepicker('option', 'dateFormat','Y-m-d');
    $('#inicio').datepicker('update', '{$fsc->fecha_inicio}');
    $('#fin').datepicker('option', 'dateFormat','Y-m-d');
    $('#fin').datepicker('update', '{$fsc->fecha_fin}');

    $(document).ready(function () {
        $('#f_generar_reporte').submit(function (event) {
            event.preventDefault();
            get_stock();
        });
    });
</script>
{include="footer"}